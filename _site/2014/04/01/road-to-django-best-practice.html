<!DOCTYPE html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <meta name="google-site-verification" content="H6k1xpusWugwaQgJsWDpiTw4J_AGFZHR4shRsOvPI78" />
  <link rel="stylesheet" href="/assets/css/pure/0.3.0/pure-min.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/pygment_trac.css">
  <title>Django Best Practiceへの道 #1</title>
</head>
<body>
<header role='banner'>
    <h1 class="blog-title">包丁一本さらしに巻いて</h1>
    <nav role='navigation'>
        <div class="pure-menu pure-menu-open pure-menu-horizontal">
            <ul>
                <li class="pure-menu-selected"><a href="/">Top</a></li>
                <li class="pure-menu-selected"><a href="/about.html">About</a></li>
                <li class="pure-menu-selected"><a href="/feed.xml">Feed</a></li>
            </ul>
        </div>
    </nav>
</header>
<article class="text">
    <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'achiku'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

<div id="fb-root">
<script>
  window.fbAsyncInit = function() {
    // init the FB JS SDK
    FB.init({
      appId      : '1447639612119183',                   // App ID from the app dashboard
      status     : true,                                 // Check Facebook Login status
      xfbml      : true                                  // Look for social plugins on the page
    });

    // Additional initialization code such as adding Event Listeners goes here
  };

  // Load the SDK asynchronously
  (function(){
     // If we've already installed the SDK, we're done
     if (document.getElementById('facebook-jssdk')) {return;}

     // Get the first script element, which we'll use to find the parent node
     var firstScriptElement = document.getElementsByTagName('script')[0];

     // Create a new script element and set its id
     var facebookJS = document.createElement('script'); 
     facebookJS.id = 'facebook-jssdk';

     // Set the new script's source to the source of the Facebook JS SDK
     facebookJS.src = '//connect.facebook.net/en_US/all.js';

     // Insert the Facebook JS SDK into the DOM
     firstScriptElement.parentNode.insertBefore(facebookJS, firstScriptElement);
   }());
</script>
</div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=1447639612119183";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class='pure-menu-heading'>
    <h1>Django Best Practiceへの道 #1</h1>
    <p>2014.04.01</p>
</div>
<div>
    <p>DjangoのWebアプリを開発している際、リファクタ/テスト拡充のために集めた情報をまとめます。</p>

<ul>
<li><a href="http://achiku.github.io/2014/04/01/road-to-django-best-practice.html">#1 Djangoプロジェクト/アプリケーション/設定ファイル構成</a></li>

<li><a href="http://achiku.github.io/2014/04/04/road-to-django-best-practice.html">#2 Djangoテスト戦術</a></li>

<li><a href="http://achiku.github.io/2014/04/14/django-pytest-webtest.html">#2 補足編</a></li>

<li><a href="http://achiku.github.io/2014/04/07/road-to-django-best-practice.html">#3 Django Model/View/From/Template戦術</a></li>
</ul>

<p>戦略よりも、自分が入社した時既にあった前提に対応する為に考えた戦術を中心に書いていきます。また、自分の思考をダンプして記録しておくという目的もあるので、記述が冗長な部分もありますがご容赦ください。</p>

<h1 id="">前提</h1>

<ul>
<li>既に本番リリースされてる</li>

<li>Django 1.5で作られてる</li>

<li>中/小規模Webアプリケーション(テーブルサイズ10 - 20)</li>

<li>開発/運用1人(achiku), アドバイザー/レビューアー1人(moquada)</li>

<li>バックエンド処理ロジックは比較的シンプル</li>

<li>Celeryを使った非同期タスクとして動く処理がある</li>

<li>JSはクリティカルな処理では使ってない(表示整形くらい)</li>

<li>トラフィックは少ない</li>

<li>インフラはAWS(VPC + ELB + EC2 + RDS)</li>
</ul>

<h1 id="_2">プロジェクト/アプリケーション構成</h1>

<h2 id="_3">アプリケーション構成に何を求めるか</h2>

<ul>
<li>巨大な1ファイルのコードが存在しえない</li>

<li>コードの見通しが自然とよくなる</li>

<li>各モジュールの依存関係が少ない</li>
</ul>

<p>Djangoにはプロジェクトとアプリケーションという思想がある。Djangoが生まれた時からある概念で、1つのプロジェクトの中に、複数のアプリケーションを入れ、各アプリケーションの依存は可能な限り少なくし、取替え可能な形にする事を目指している。では実戦レベルでどのように分割するのが良いのか、という指針を実例を交えながら語ってくれているのが以下の資料。2008年の資料だけど、Djangoの根本的な思想は変わっていないので未だ有効だと思う。あと、”Do one thing, and one thing well”って本当にすごいかっこいいし、この思想を実装しているGNUやUNIX的なものはさらにかっこいいと思う。</p>

<p><em>DjangoCon 2008: Reusable Apps</em></p>

<ul>
<li><a href="http://www.youtube.com/watch?v=A-S0tqpPga4">YouTube: DjangoCon 2008: Reusable Apps</a></li>

<li><a href="http://media.b-list.org/presentations/2008/pycon/reusable_apps.pdf">Developing reusable apps</a></li>
</ul>

<p>上の資料を参考に設計する利点は主に2つ。</p>

<p><strong>メンテナンスしやすくなる</strong></p>

<p>このアプリケーション分割をすることで、「巨大な1ファイルのコード」が存在し得ない構成となる。誰かが意識してメンテしにくい巨大な1ファイルを作らないようにする、ではなく、そもそもそんなものが発生し得ない構成にすることが肝要だと思った。</p>

<p><strong>各モジュールの再利用可能性向上</strong></p>

<p>普通の単独自社サービスであれば、そこまで再利用性を高める為に時間をかける必要はない気がするけど、Djangoを使った自社サービスが複数ある中でのライブラリ作成や、個別のお客さんによってカスタマイズが必要なパッケージ、というシチュエーションであればある程度時間をかけて設計する価値はあると思う。実際上の資料内でJamesさんが自社パッケージを各お客さん用にカスタマイズする際に、プラガブルに設計してて助かったぜ、という話がある。</p>

<h2 id="_4">プロジェクト構成に何を求めるか</h2>

<ul>
<li>共通な部分と固有な部分を直感的に分けたい</li>

<li>何かを作る時にどのディレクトリに入れるべきか可能な限り迷いたくない</li>
</ul>

<h2 id="_5">実装</h2>

<p>他の流派もあるのですが、一旦現在は以下のような形に落ち着いています。まだまだ継続改善中。</p>

<pre><code>project
├── apps
│   ├── appA
│   ├── appB
│   └── appC
├── core
│   └── settings
├── docs
│   ├── files
│   └── styleguide
├── fixtures
├── libs
│   └── management
│       └── commands
├── requirements
├── server-config
├── static
├── templates
└── tests</code></pre>

<p>上から順に概要を説明します。</p>

<ul>
<li>
<p>apps</p>

<ul>
<li>Djangoアプリケーションを格納。</li>

<li>アプリケーションを何単位で作るのかは先述の資料を参考に要議論。</li>

<li>apps内のディレクトリ構成は、”‘tests”’, ”‘migrations”’, ”‘templates”‘が基本。(South利用前提)</li>

<li>“Do one thing, and one thing well.”の原則。</li>
</ul>
</li>

<li>
<p>core</p>

<ul>
<li>設定ファイル群を格納。各環境用の設定ファイルを<code>settings</code>ディレクトリに格納しておく。(詳細後述)</li>

<li>wsgiファイルを格納。</li>

<li>ROOT_URLを格納し、必ずここから各アプリケーションにルーティング。</li>
</ul>
</li>

<li>
<p>docs</p>

<ul>
<li>プロジェクトのドキュメントを格納(仕様等)</li>

<li>README.rstをリポジトリのトップにおいておき、そこから参照させる形で。</li>
</ul>
</li>

<li>
<p>fixtures</p>

<ul>
<li>Djangoのコンテクストでのfixtureは極力使わないけど、マスタデータセットアップで必要な場合は使う(住所コード等)。</li>

<li>テスト時に利用するアップロード用ファイルを置いておく。</li>
</ul>
</li>

<li>
<p>libs</p>

<ul>
<li>各Djangoアプリケーションから利用される共通的な処理を格納、定数を格納。</li>

<li>カスタムで作成するmanage.pyのコマンドもここに入れていく。</li>
</ul>
</li>

<li>
<p>requirements</p>

<ul>
<li>プロジェクトに必要なライブラリを記載したrequirements.txtを入れる。</li>

<li>各環境用 x テスト+開発に必須なrequirementsを分け、同じライブラリが複数ファイルに入るのを防ぐ。</li>

<li>requirements/common.txt, test.txt, development.txt等(詳細は後で)</li>
</ul>
</li>

<li>
<p>server-config</p>

<ul>
<li>サーバ(OS)レベルで必要なファイルの格納(e.g. bash_profile, ssh_config)。</li>

<li>ミドルウェア(e.g. uwsgi, nginx, celery, supervisor)を動かす為に必要なファイルの格納。</li>

<li>本当はこの辺Ansibleで統一したい。</li>
</ul>
</li>

<li>
<p>static</p>

<ul>
<li>CSS, JS, Image等を入れる。</li>
</ul>
</li>

<li>
<p>templates</p>

<ul>
<li>アプリ全体で使いまわすテンプレ(ナビゲーションとか)を格納。</li>
</ul>
</li>

<li>
<p>tests</p>

<ul>
<li>各Djangoアプリケーション内のテストで共通的に利用するものを格納。</li>

<li>具体例でいうと、”‘factories.py”’, ”‘conftest.py”‘。(factory_boy, py.test利用前提)</li>
</ul>
</li>
</ul>

<p>この辺りはDjangoのテンプレート系ライブラリをかなり参考にしました。 有名なものになると、色々な知見が凝縮されており、読んでいるだけで楽しくなれます。</p>

<ul>
<li><a href="https://github.com/rdegges/django-skel">django-skel</a></li>

<li><a href="https://github.com/amccloud/django-project-skel">django-project-skel</a></li>

<li><a href="https://github.com/theduke/django-kickstart">django-kickstart</a></li>
</ul>

<p>Two Scoops of Djangoで紹介されていた構成。これも非常に参考になる。</p>

<ul>
<li><a href="https://github.com/twoscoops/django-twoscoops-project">django-twoscoops-project</a></li>
</ul>

<p>参考になるライブラリ群</p>

<ul>
<li><a href="https://www.djangopackages.com/grids/g/project-templates/">Django Packages - Project Templates</a></li>
</ul>

<h1 id="_6">設定ファイル構成</h1>

<h2 id="_7">設定ファイル構成に何を求めるか</h2>

<ul>
<li>各環境別に異なる設定が明確</li>

<li>全環境で共通な設定が明確</li>

<li>各環境別に柔軟な設定変更が可能</li>

<li>ローカルでは自分だけの設定も入れれる柔軟性が必要</li>
</ul>

<p>1番目と2番めが非常に重要だと思ってます。可能な限り1番目と2番めの目標が達成できるようにする、という指針で以下のようにしました。</p>

<h2 id="_8">設定ファイル実装</h2>

<ul>
<li>common.pyに各環境共通の設定を入れる (大事なのは「本当に共通で使う」ものだけ入れる。DBの設定は後のimportで上書きされるから一応いれる、とかやらない。)</li>

<li>各環境用の設定ファイルを作成し、最初にcommon.pyから設定を全てimport
<ul>
<li>development.py</li>

<li>staging.py</li>

<li>production.py</li>

<li>local_test.py</li>

<li>ci.py</li>

<li>local.sample.py</li>
</ul>
</li>

<li>各環境用設定ファイルの最後でlocal.pyから設定をimportする</li>
</ul>

<p>common.py以外は大体以下のような形になってます。</p>
<div class='highlight'><pre><code class='python'><span class='c'># -*- coding: utf-8 -*-</span>
<span class='kn'>from</span> <span class='nn'>core.settings.common</span> <span class='kn'>import</span> <span class='o'>*</span>  <span class='c'># NOQA</span>

<span class='n'>DEBUG</span> <span class='o'>=</span> <span class='bp'>True</span>
<span class='n'>TEMPLATE_DEBUG</span> <span class='o'>=</span> <span class='bp'>True</span>
<span class='n'>ENVIRONMENT</span> <span class='o'>=</span> <span class='s'>&#39;staging&#39;</span>
<span class='n'>DATABASES</span> <span class='o'>=</span> <span class='p'>{</span>
    <span class='s'>&#39;default&#39;</span><span class='p'>:</span> <span class='p'>{</span>
        <span class='s'>&#39;ENGINE&#39;</span><span class='p'>:</span> <span class='s'>&#39;django.db.backends.mysql&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;NAME&#39;</span><span class='p'>:</span> <span class='s'>&#39;django2&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;USER&#39;</span><span class='p'>:</span> <span class='s'>&#39;hoge_user&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;PASSWORD&#39;</span><span class='p'>:</span> <span class='s'>&#39;hoge_password&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;HOST&#39;</span><span class='p'>:</span> <span class='s'>&#39;hogehost&#39;</span><span class='p'>,</span>
        <span class='s'>&#39;PORT&#39;</span><span class='p'>:</span> <span class='s'>&#39;&#39;</span><span class='p'>,</span>
    <span class='p'>}</span>
<span class='p'>}</span>

<span class='k'>try</span><span class='p'>:</span>
    <span class='kn'>from</span> <span class='nn'>core.settings.local</span> <span class='kn'>import</span> <span class='o'>*</span>  <span class='c'># NOQA</span>
<span class='k'>except</span> <span class='ne'>ImportError</span><span class='p'>:</span>
    <span class='k'>pass</span>
</code></pre></div>
<p>以下若干わかりにくそうな部分を解説します。</p>

<p><strong>local.sample.py</strong></p>

<p>各開発者がローカルで開発/テストする際に独自で入れる設定用ファイル。 local.sample.py内には特に何も設定されておらず、以下のようなコメントがあるのみ。</p>

<pre><code>
# -*- coding: utf-8 -*-
# ローカル環境用設定ファイル。以下のようにコピーして利用すること。
# cp local.sample.py local.py
</code></pre>

<p><code>core/settings/local.py</code>は<code>.gitignore</code>に記載しておき、リポジトリからは無視しておく。この<code>local.py</code>に各開発者用の独自設定を入れていきます。<a href="http://www.amazon.com/Two-Scoops-Django-Best-Practices/dp/098146730X">Two Scoops of Django</a>では各開発チームメンバーの独自設定もVCSに入れる事を推奨しています。理由としてあげているのは、「有害な設定を入れていたら指摘できる」「便利な設定を入れていたら共有できる」という事でしたが、正直独自設定を入れなくとも上記2点は達成可能なのであまりしっくり来ていませんので弊社では採用していません。</p>

<p><strong>local_test.py</strong></p>

<p>ローカルでテストを実行する時に利用する設定で、PASSWORD_HASHERSとかを変更、DBをsqliteのインメモリにしたり、テストを高速化するための工夫が施してある。この中身についてはテスト戦術で詳細に書きます。</p>

<p>その他の設定ファイルは大体名前の通りの内容が入ってます。</p>

<h2 id="_9">設定ファイル切り替え実装</h2>

<p>manage.pyにはcore.developmentを直書きで指定し、開発用サーバ(manage.py runserver)は開発用設定がデフォルトで動くようにしています。これでローカルには特に環境変数設定せずともシンプルにmanage.py runserverすれば開発用サーバを起動できるようになってます。<a href="https://gist.github.com/voluntas/6855579">Djangoトラノマキ</a>参照</p>
<div class='highlight'><pre><code class='python'><span class='c'>#!/usr/bin/env python</span>
<span class='kn'>import</span> <span class='nn'>os</span>
<span class='kn'>import</span> <span class='nn'>sys</span>

<span class='k'>if</span> <span class='n'>__name__</span> <span class='o'>==</span> <span class='s'>&quot;__main__&quot;</span><span class='p'>:</span>
    <span class='n'>os</span><span class='o'>.</span><span class='n'>environ</span><span class='o'>.</span><span class='n'>setdefault</span><span class='p'>(</span><span class='s'>&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class='p'>,</span> <span class='s'>&quot;core.settings.development&quot;</span><span class='p'>)</span>

    <span class='kn'>from</span> <span class='nn'>django.core.management</span> <span class='kn'>import</span> <span class='n'>execute_from_command_line</span>

    <span class='n'>execute_from_command_line</span><span class='p'>(</span><span class='n'>sys</span><span class='o'>.</span><span class='n'>argv</span><span class='p'>)</span>
</code></pre></div>
<p>各環境(CI、ステージング、本番)用に作成したファイルは、アプリケーション実行ユーザの環境変数にDJANGO_SETTINGS_MODULEを設定して切り替える方式としています。</p>

<pre><code>
export DJANGO_SETTINGS_MODULE=core.config.staging
</code></pre>

<p><em>参考文献</em></p>

<ul>
<li><a href="http://d.hatena.ne.jp/nullpobug/20131015/1381763671">Djangoのsettingsの分割と構造化について –偏った言語信者の垂れ流し</a></li>

<li><a href="https://gist.github.com/voluntas/6855579">Django トラノマキ</a></li>

<li><a href="http://surgo.jp/2010/02/django.html">パーフェクトな Django の設定ファイル</a></li>
</ul>

<p>次回はDjangoにおけるテスト戦術について書きます。</p>

<ul>
<li><a href="http://achiku.github.io/2014/04/01/road-to-django-best-practice.html">#1 Djangoプロジェクト/アプリケーション/設定ファイル構成</a></li>

<li><a href="http://achiku.github.io/2014/04/04/road-to-django-best-practice.html">#2 Djangoテスト戦術</a></li>

<li><a href="http://achiku.github.io/2014/04/14/django-pytest-webtest.html">#2 補足編</a></li>

<li><a href="http://achiku.github.io/2014/04/07/road-to-django-best-practice.html">#3 Django Model/View/From/Template戦術</a></li>
</ul>
</div>
<div class="post-sharing">
 

  
  		<a href="https://twitter.com/share" class="twitter-share-button" data-text="Django Best Practiceへの道 #1" data-via="" data-related="_achiku" data-count="" data-size="">Tweet</a>

<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

	



<a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-title="Django Best Practiceへの道 #1" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

<div class="fb-like" data-href="" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div>

</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'achiku'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50431971-1', 'achiku.github.io');
  ga('send', 'pageview');

</script>
<footer>
</footer>
</body>
